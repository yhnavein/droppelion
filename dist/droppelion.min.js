var app=angular.module("droppelion",[]);app.directive("droppelion",function($timeout,$http,$filter,$q){return{restrict:"E",transclude:!0,replace:!0,scope:{dynamic:"=",endpoint:"=",traverse:"@",prompt:"@",item:"=",controlId:"@",title:"@",onSelect:"&"},link:function(scope,elem,attrs){var self={};attrs.dynamic||(attrs.dynamic=!0),"string"==typeof attrs.dynamic&&(attrs.dynamic="true"===attrs.dynamic.toLowerCase()),attrs.dynamic&&scope.$watch("itemName",function(){scope.filteredItems=$filter("filter")(scope.items,scope.itemName)}),self.hideDropDown=function(){self.cancelActiveRequest(),scope.loading=!1,scope.dropDownVisible=!1,scope.filteredItems=[]},self.cancelActiveRequest=function(){self.canceler&&self.canceler.resolve()},self.getItems=function(data){var dataToShow=scope.traverse?data[scope.traverse]:data;scope.items=dataToShow,scope.loading=!1,scope.dropDownVisible=!0,scope.filteredItems=scope.items},self.logQueryError=function(err){null!=err&&(console.error(err),self.hideDropDown())},self.makeSearchRequest=function(query){return!query||query.length<2?(self.hideDropDown(),void(null!=self.searchTimeout&&$timeout.cancel(self.searchTimeout))):(null!=self.searchTimeout&&$timeout.cancel(self.searchTimeout),void(self.searchTimeout=$timeout(function(){scope.loading=!0,self.cancelActiveRequest(),self.canceler=$q.defer(),$http.get(scope.endpoint,{params:{q:query},timeout:self.canceler.promise}).success(self.getItems).error(self.logQueryError)},200)))},attrs.dynamic||(scope.loading=!0,$http.get(scope.endpoint).success(self.getItems).error(self.logQueryError)),scope.blur=function(){$timeout(function(){scope.focused=!1,self.hideDropDown()},100)},scope.handleSelection=function(selectedItem){null==selectedItem&&(selectedItem=scope.filteredItems[scope.current]),console.log("Sel item: "+selectedItem),console.log("Current "+scope.current),scope.item=selectedItem,scope.itemName=selectedItem[scope.title],scope.current=0,scope.selected=!0,self.hideDropDown(),scope.onSelect()},scope.clearSelection=function(){scope.selected=!1,scope.item={},scope.itemName=""},scope.current=0,scope.dropDownVisible=!1,scope.isCurrent=function(index){return scope.current==index},scope.setCurrent=function(index){scope.current=index},scope.changedSearch=function(){attrs.dynamic&&self.makeSearchRequest(scope.itemName)},scope.keyPressed=function(e){if(null!=scope.filteredItems){if(13===e.keyCode)return void scope.handleSelection(null);if(27===e.keyCode||9===e.keyCode)return void self.hideDropDown();38===e.keyCode?0===scope.current?scope.current=scope.filteredItems.length-1:scope.current--:40===e.keyCode&&(scope.current===scope.filteredItems.length-1?scope.current=0:scope.current++),scope.dropDownVisible=!0}}},templateUrl:"templates/droppelion.html"}});