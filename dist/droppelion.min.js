var app=angular.module("droppelion",[]);app.directive("droppelion",["$timeout","$http","$filter","$document","$q",function($timeout,$http,$filter,$document,$q){return{restrict:"E",transclude:!0,replace:!0,scope:{endpoint:"=",traverse:"@",prompt:"@",item:"=",api:"=",title:"@",customIndex:"@",onSelect:"&",onNewItemSelect:"&"},link:function(scope,elem){var self={};scope.$watch("itemName",function(){scope.filteredItems=$filter("filter")(scope.items,scope.itemName)}),scope.$watch("item",function(){scope.selected&&!angular.equals(scope.item,self.selItem)&&scope.clearSelection()}),self.hideDropDown=function(){self.cancelActiveRequest(),scope.loading=!1,scope.dropDownVisible=!1,scope.filteredItems=[]},self.cancelActiveRequest=function(){self.canceler&&self.canceler.resolve()},self.getItems=function(data){var dataToShow=scope.traverse?data[scope.traverse]:data;scope.items=dataToShow,scope.loading=!1,scope.dropDownVisible=!0,scope.filteredItems=scope.items},self.logQueryError=function(err){null!=err&&(console.error(err),self.hideDropDown())},self.makeSearchRequest=function(query){return!query||query.length<2?(self.hideDropDown(),void(null!=self.searchTimeout&&$timeout.cancel(self.searchTimeout))):(null!=self.searchTimeout&&$timeout.cancel(self.searchTimeout),void(self.searchTimeout=$timeout(function(){scope.loading=!0,self.cancelActiveRequest(),self.canceler=$q.defer(),$http.get(scope.endpoint,{params:{q:query},timeout:self.canceler.promise}).success(self.getItems).error(self.logQueryError)},200)))},$document.on("click",function(ev){var isChild=elem.find(ev.target).length>0;isChild||scope.$apply(function(){scope.focused=!1,self.hideDropDown()})}),scope.handleSelection=function(selectedItem){(null!=selectedItem||(selectedItem=scope.filteredItems[scope.current],null!=selectedItem))&&(self.selItem=angular.copy(selectedItem),scope.item=selectedItem,scope.itemName=selectedItem[scope.title],scope.current=0,scope.selected=!0,self.hideDropDown(),scope.onSelect())},scope.clearSelection=function(){scope.selected=!1,scope.item={},scope.itemName=""},scope.newItemClicked=function(){self.hideDropDown(),scope.focused=!1,self.hideDropDown(),null!=scope.onNewItemSelect&&"function"==typeof scope.onNewItemSelect&&scope.onNewItemSelect()},scope.current=0,scope.dropDownVisible=!1,scope.isCurrent=function(index){return scope.current==index},scope.setCurrent=function(index){scope.current=index},scope.changedSearch=function(){self.makeSearchRequest(scope.itemName)},scope.api={selectItem:scope.handleSelection,clear:scope.clearSelection,itemName:function(){return scope.itemName}},elem.on("keydown keypress paste",function(e){if(9===e.keyCode)return scope.focused=!1,self.hideDropDown(),void scope.$apply();if(null!=scope.filteredItems){if(13===e.keyCode)return void scope.handleSelection(null);if(27===e.keyCode)return void self.hideDropDown();38===e.keyCode?0===scope.current?scope.current=scope.filteredItems.length-1:scope.current--:40===e.keyCode&&(scope.current===scope.filteredItems.length-1?scope.current=0:scope.current++),scope.$apply(),scope.dropDownVisible=!0}})},templateUrl:"/templates/droppelion.html"}}]),app.directive("spyScroll",function(){function updateScroll($list,index){var el=$list.children().eq(index);if(null==el||0===el.length)return void $list.scrollTop(0);var elTop=el.position().top,elBottom=elTop+el.outerHeight(),scrollTop=$list.scrollTop(),resHeight=$list.outerHeight();0>elTop&&$list.scrollTop(scrollTop+elTop),elBottom>resHeight&&$list.scrollTop(scrollTop+elBottom-resHeight)}return{restrict:"A",link:function(scope,element){scope.$watch("current",function(newVal,oldVal){newVal!=oldVal&&updateScroll(element,newVal)})}}});